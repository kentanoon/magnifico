# データベース構造詳細仕様書
## マニフィコ建築事務所様 申請管理システム

---

## 📊 データベース全体像

```
┌─────────────────┐
│   顧客マスタ    │
│  (18カラム)     │
│  cust_XXX       │
└────────┬────────┘
         │
         │ 1:N
         │
         ▼
┌─────────────────┐
│   案件マスタ    │
│  (84カラム)     │
│  proj_XXX       │
└────────┬────────┘
         │
         │ 1:N
         │
         ▼
┌─────────────────┐
│ 書類作成履歴    │
│  (11カラム)     │
│  DOC_XXXX       │
└─────────────────┘
```

---

## 1️⃣ 顧客マスタ（customer_master）

### テーブル構造
| # | カラム名 | データ型 | 必須 | 説明 | 例 |
|---|---------|---------|------|------|-----|
| 1 | 顧客ID | String | ✓ | 主キー（cust_XXX形式） | cust_003 |
| 2 | 顧客区分 | String | ✓ | 法人/個人 | 法人 |
| 3 | 名称1(社名/氏名) | String | ✓ | 顧客名称 | 株式会社アオイ建設 |
| 4 | フリガナ | String | ✓ | 名称1のフリガナ | カブシキガイシャアオイケンセツ |
| 5 | 名称2(代表/家族) | String | - | 代表者名または家族名 | 代表取締役 田中一郎 |
| 6 | フリガナ | String | - | 名称2のフリガナ | ダイヒョウトリシマリヤク タナカイチロウ |
| 7 | 郵便番号(現住所) | String | ✓ | XXX-XXXX形式 | 150-0001 |
| 8 | 連絡先住所(請求書送付先) | String | ✓ | 住所 | 東京都渋谷区神宮前X-X-X |
| 9 | 電話番号 | String | ✓ | ハイフンあり | 03-3456-7890 |
| 10 | Email | String | ✓ | メールアドレス | info@aoi-k.co.jp |
| 11 | FAX | String | - | FAX番号 | 03-3456-7891 |
| 12 | 建設業許可番号 | String | - | 許可番号 | 東京都知事(5)第12345号 |
| 13 | 業種 | String | - | 主な業種 | 建築工事業 |
| 14 | 顧客ステータス | String | ✓ | A〜E分類 | A (優良) |
| 15 | 記事(備考) | String | - | 自由記述 | 複数案件実績あり |
| 16 | 登録日時 | DateTime | ✓ | 初回登録日時 | 2024-01-10 09:00:00 |
| 17 | 更新日時 | DateTime | ✓ | 最終更新日時 | 2025-11-20 14:30:00 |
| 18 | 削除フラグ | Boolean | ✓ | True/False | False |

### 顧客ステータス区分
| コード | 名称 | 説明 |
|--------|------|------|
| A | 優良 | 継続的な取引実績、信頼性が高い |
| B | 新規 | 新規取引先、実績構築中 |
| C | 見込み | 見積提出済み、受注見込みあり |
| D | 休眠 | 過去取引あり、現在取引なし |
| E | 要注意 | 連絡不通、取引停止候補 |

### 顧客区分
| 区分 | 説明 | 必須項目の違い |
|------|------|----------------|
| 法人 | 企業、事業者 | 建設業許可番号が重要 |
| 個人 | 個人顧客 | 名称2は家族名など |

### サンプルデータ件数
- 総レコード数：16件
- 法人：10件
- 個人：6件
- 削除フラグTrue：1件（cust_012）

---

## 2️⃣ 案件マスタ（project_master）

### カテゴリ構成（全84カラム）

#### A. マスタ情報（22カラム）
| # | カラム名 | データ型 | 必須 | 説明 |
|---|---------|---------|------|------|
| 1 | 案件ID | String | ✓ | 主キー（proj_XXX） |
| 2 | 顧客ID | String | ✓ | 外部キー（顧客マスタ） |
| 3 | 案件名 | String | ✓ | プロジェクト名称 |
| 4 | 現場住所 | String | ✓ | 工事現場の住所 |
| 5 | 工事種別 | String | ✓ | 新築/修繕/改修等 |
| 6 | 契約日(予定) | DateTime | - | 契約予定日 |
| 7 | 引渡日(予定) | DateTime | - | 引渡予定日 |
| 8 | ステータス | String | ✓ | 計画中/施工中/完了 |
| 9 | フォルダURL | String | - | GoogleDrive保存先 |
| 10 | 依頼内容 | String | - | 工事内容概要 |
| 11 | ステータス | String | - | 進捗状況 |
| 12-16 | 連絡事項1〜5 | String | - | 各種連絡事項 |
| 17-21 | 検査報告1〜5 | Boolean | - | 検査実施フラグ |
| 22 | 担当チーム | String | - | 設計部/工事部等 |

#### B. 敷地情報（16カラム）
| # | カラム名 | データ型 | 必須 | 説明 |
|---|---------|---------|------|------|
| 23 | 建設地住所 | String | ✓ | 正式な建設地住所 |
| 24 | 都市計画地域 | String | - | 第一種低層等 |
| 25 | 用途地域 | String | - | 用途地域区分 |
| 26 | 防火地域 | String | - | 防火/準防火 |
| 27 | 斜線制限 | Number | - | 斜線制限値 |
| 28 | 外壁後退 | String | - | 外壁後退距離 |
| 29 | 敷地面積（㎡） | Number | - | 敷地面積 |
| 30 | 敷地内他建物 | String | - | 有り/無し |
| 31 | 物件名 | String | - | 建物名称 |
| 32 | 工事の種類 | String | - | 新築工事/改修工事 |
| 33 | 主要用途 | String | - | 一戸建て/事務所等 |
| 34 | 構造 | String | - | 木造/RC/SRC等 |
| 35 | 階数 | Number | - | 地上階数 |
| 36 | 最高の高さ | Number | - | 建物高さ（m） |
| 37 | 延床面積（㎡） | Number | - | 延床面積 |
| 38 | 建築面積（㎡） | Number | - | 建築面積 |

#### C. 申請種類（13カラム）
| # | カラム名 | データ型 | 必須 | 説明 |
|---|---------|---------|------|------|
| 39 | 60条 | String | - | 60条適合/適用外 |
| 40 | みなし道路 | Boolean | - | True/False |
| 41 | LVS・消防 | String | - | 適合/適用外 |
| 42 | 地区計画 | String | - | 適合/適用外 |
| 43 | 29条 | Boolean | - | True/False |
| 44 | 43条 | Boolean | - | True/False |
| 45 | 長期優良 | Boolean | - | True/False |
| 46 | ZEH | Boolean | - | True/False |
| 47 | 低炭素 | Boolean | - | True/False |
| 48 | 性能向上 | Boolean | - | True/False |
| 49 | 性能評価 | Boolean | - | True/False |
| 50 | その他 | String | - | その他の申請種別 |
| 51 | その他の申請 | String | - | 詳細説明 |

#### D. 関連情報（9カラム）
| # | カラム名 | データ型 | 必須 | 説明 |
|---|---------|---------|------|------|
| 52 | 契約日 | DateTime | - | 正式契約日 |
| 53 | 契約金額 | Number | - | 契約金額 |
| 54 | 確認申請番号 | String | - | 確認申請番号 |
| 55 | 設計者 | String | - | 設計担当者/事務所 |
| 56 | 監理者 | String | - | 監理担当者/事務所 |
| 57 | 発注者代表 | String | - | 発注者代表者名 |
| 58 | 瑕疵保険 | String | - | 加入済み/未加入 |
| 59 | 保険会社 | String | - | 保険会社名 |
| 60 | 瑕疵保険番号 | String | - | 保険証券番号 |

#### E. 申請工程（12カラム）
| # | カラム名 | データ型 | 必須 | 説明 |
|---|---------|---------|------|------|
| 61 | 事前予定 | DateTime | - | 事前協議予定日 |
| 62 | 事前実績 | DateTime | - | 事前協議実施日 |
| 63 | 役調予定 | DateTime | - | 役所調査予定日 |
| 64 | 役調実績 | DateTime | - | 役所調査実施日 |
| 65 | 現調予定 | DateTime | - | 現地調査予定日 |
| 66 | 現調実績 | DateTime | - | 現地調査実施日 |
| 67 | 付随申請予定 | DateTime | - | 付随申請予定日 |
| 68 | 付随申請実績 | DateTime | - | 付随申請実施日 |
| 69 | 確認申請予定 | DateTime | - | 確認申請予定日 |
| 70 | 確認申請決裁 | DateTime | - | 確認申請承認日 |
| 71 | 性能申請予定 | DateTime | - | 性能申請予定日 |
| 72 | 性能申請実績 | DateTime | - | 性能申請実施日 |

#### F. 監理工程（8カラム）
| # | カラム名 | データ型 | 必須 | 説明 |
|---|---------|---------|------|------|
| 73 | 着工予定 | DateTime | - | 着工予定日 |
| 74 | 着工実績 | DateTime | - | 着工実施日 |
| 75 | 配筋予定 | DateTime | - | 配筋検査予定日 |
| 76 | 配筋実績 | DateTime | - | 配筋検査実施日 |
| 77 | 中間予定 | DateTime | - | 中間検査予定日 |
| 78 | 中間実績 | DateTime | - | 中間検査実施日 |
| 79 | 完了予定 | DateTime | - | 完了検査予定日 |
| 80 | 完了実績 | DateTime | - | 完了検査実施日 |

#### G. その他・Logデータ（4カラム）
| # | カラム名 | データ型 | 必須 | 説明 |
|---|---------|---------|------|------|
| 81 | 記事(備考) | String | - | 自由記述 |
| 82 | 登録日時 | DateTime | ✓ | 初回登録日時 |
| 83 | 更新日時 | DateTime | ✓ | 最終更新日時 |
| 84 | 削除フラグ | Boolean | ✓ | True/False |

### 工事種別マスタ
| 種別 | 説明 |
|------|------|
| 新築 | 新築工事 |
| 修繕 | 修繕工事 |
| 改修 | 改修・リフォーム工事 |
| 解体 | 解体工事 |

### ステータスマスタ
| ステータス | 説明 |
|-----------|------|
| 計画中 | 設計・計画段階 |
| 施工中 | 工事実施中 |
| 完了 | 工事完了 |
| 中止 | プロジェクト中止 |

---

## 3️⃣ 書類作成履歴（document_history）

### テーブル構造
| # | カラム名 | データ型 | 必須 | 説明 | 例 |
|---|---------|---------|------|------|-----|
| 1 | 書類ID | String | ✓ | 主キー（DOC_XXXX） | DOC_0015 |
| 2 | 顧客ID | String | ✓ | 外部キー（顧客マスタ） | CUST_008 |
| 3 | 案件ID | String | ✓ | 外部キー（案件マスタ） | PROJ_022 |
| 4 | 書類種別 | String | ✓ | 見積書/請求書等 | 見積書 |
| 5 | 発行日 | DateTime | ✓ | 書類発行日 | 2025-11-25 |
| 6 | 金額 | Number | - | 金額（円） | 350000 |
| 7 | 作業内容 | String | - | 作業内容詳細 | 〇〇工事設計費 |
| 8 | PDF保存先 | String | - | PDF保存URL | [URL] |
| 9 | 作成日時 | DateTime | ✓ | システム登録日時 | 2025-11-26 09:30:00 |
| 10 | 備考 | String | - | 自由記述 | 金額調整中 |
| 11 | 削除フラグ | Boolean | ✓ | True/False | False |

### 書類種別マスタ
| 種別 | 説明 | 金額必須 |
|------|------|---------|
| 見積書 | 工事見積書 | ✓ |
| 請求書 | 請求書 | ✓ |
| 領収書 | 領収書 | ✓ |
| 契約書 | 工事請負契約書 | ✓ |
| 発注書 | 下請け発注書 | ✓ |
| 確認申請書 | 建築確認申請書 | - |
| 完了検査申請書 | 完了検査申請書 | - |
| 変更契約書 | 変更契約書 | ✓ |
| 覚書 | 業務提携覚書等 | - |
| 届出書 | 各種届出書 | - |

### サンプルデータ統計
- 総レコード数：17件
- 見積書：3件
- 請求書：5件
- その他：9件

---

## 🔗 リレーションシップ

### ER図（簡易版）
```
┌──────────────────────┐
│   顧客マスタ          │
│  ──────────────────  │
│  PK: 顧客ID          │
│  ──────────────────  │
│  顧客区分             │
│  名称1                │
│  Email               │
│  顧客ステータス       │
│  ...                 │
└──────────┬───────────┘
           │
           │ 1
           │
           │ N
           ▼
┌──────────────────────┐       ┌──────────────────────┐
│   案件マスタ          │       │  書類作成履歴         │
│  ──────────────────  │       │  ──────────────────  │
│  PK: 案件ID          │◄──────│  PK: 書類ID          │
│  FK: 顧客ID          │   N   │  FK: 顧客ID          │
│  ──────────────────  │       │  FK: 案件ID          │
│  案件名               │       │  ──────────────────  │
│  工事種別             │       │  書類種別             │
│  契約日               │       │  発行日               │
│  ステータス           │       │  金額                 │
│  ...                 │       │  PDF保存先           │
└──────────────────────┘       └──────────────────────┘
```

### 外部キー制約
1. **案件マスタ.顧客ID → 顧客マスタ.顧客ID**
   - 制約：ON DELETE RESTRICT（顧客削除時は関連案件の事前確認が必要）
   
2. **書類作成履歴.顧客ID → 顧客マスタ.顧客ID**
   - 制約：ON DELETE RESTRICT

3. **書類作成履歴.案件ID → 案件マスタ.案件ID**
   - 制約：ON DELETE CASCADE（案件削除時は関連書類も削除）

---

## 🔍 インデックス設計

### 顧客マスタ
- PRIMARY KEY: 顧客ID
- INDEX: 顧客ステータス（検索頻度高）
- INDEX: Email（ログイン・認証用）
- INDEX: 削除フラグ（有効データ抽出用）

### 案件マスタ
- PRIMARY KEY: 案件ID
- INDEX: 顧客ID（JOIN頻度高）
- INDEX: ステータス（ダッシュボード表示用）
- INDEX: 契約日（日付範囲検索用）
- INDEX: 削除フラグ

### 書類作成履歴
- PRIMARY KEY: 書類ID
- INDEX: 顧客ID
- INDEX: 案件ID
- INDEX: 書類種別（絞り込み検索用）
- INDEX: 発行日（日付範囲検索用）

---

## 🛡️ データ整合性ルール

### バリデーションルール

#### 顧客マスタ
| 項目 | ルール |
|------|--------|
| 顧客ID | cust_XXX形式、重複不可 |
| Email | Email形式、重複不可 |
| 電話番号 | ハイフンあり形式 |
| 郵便番号 | XXX-XXXX形式 |
| 顧客ステータス | A/B/C/D/Eのいずれか |

#### 案件マスタ
| 項目 | ルール |
|------|--------|
| 案件ID | proj_XXX形式、重複不可 |
| 顧客ID | 顧客マスタに存在すること |
| 契約日 ≦ 引渡日 | 日付の整合性 |
| 敷地面積 > 0 | 正の値 |
| 予定日 ≦ 実績日 | 各工程で予定≦実績 |

#### 書類作成履歴
| 項目 | ルール |
|------|--------|
| 書類ID | DOC_XXXX形式、重複不可 |
| 顧客ID | 顧客マスタに存在すること |
| 案件ID | 案件マスタに存在すること |
| 金額 ≧ 0 | 非負の値 |
| 発行日 ≦ 作成日時 | 日付の整合性 |

---

## 📝 データライフサイクル

### 論理削除の運用
- すべてのテーブルで「削除フラグ」による論理削除を採用
- 削除フラグ=Trueのデータは画面表示から除外
- 物理削除は行わない（監査証跡の保持）

### バックアップ戦略
- **頻度**: 毎日深夜2:00自動実行（GASトリガー）
- **保存先**: Google Drive専用フォルダ
- **世代管理**: 過去7日分を保持
- **リストア**: 手動でのインポート機能を実装

### データアーカイブ
- 削除フラグ=Trueのデータは3年後にアーカイブ
- アーカイブデータは別シートに移動
- 必要に応じて参照可能な状態を維持

---

## 🚀 パフォーマンス最適化

### データ量の想定
- **顧客マスタ**: 年間50件の新規顧客 → 5年で250件
- **案件マスタ**: 年間100件の新規案件 → 5年で500件
- **書類作成履歴**: 年間500件の書類 → 5年で2,500件

### クエリ最適化
1. **ダッシュボード表示**
   - 削除フラグ=Falseのデータのみを取得
   - ステータス別の件数集計はインデックスを活用

2. **顧客検索**
   - 名称、Email、電話番号での部分一致検索
   - LIKE句の使用を最小限に抑える

3. **案件一覧**
   - ページネーション実装（1ページ20件）
   - 日付範囲指定での絞り込み

---

## 🎯 次のステップ

### 実装前の確認事項
1. [ ] Googleスプレッドシートのシート構成確認
2. [ ] 各シートの列順序の最終確定
3. [ ] サンプルデータの充実化
4. [ ] 入力フォームの項目順序確定
5. [ ] ダッシュボードに表示する集計項目の確定

### GAS実装での注意点
1. **同時実行対策**
   - LockServiceの活用
   - データ取得時のキャッシュ機構

2. **処理速度**
   - 大量データはバッチ処理
   - 6分制限を考慮した分割処理

3. **エラーハンドリング**
   - try-catch-finallyの徹底
   - エラーログシートへの記録

---

この仕様書をベースに、次のモック作成フェーズに進むことができます。
質問や追加の詳細化が必要な項目があれば、お気軽にご相談ください！
